# 🌙 月升月落 - 月相演示程序

一个基于Python和Skyfield天文库的月相和月升月落时间演示程序，帮助理解月亮的运行规律。

## 项目简介

这个程序可以：
- 📅 显示任意月份的月相日历
- 🌕 计算精确的月升月落时间
- 🏙️ 支持中国50个主要城市
- 📖 展示农历日期和中国传统天文术语
- 📚 提供天文知识教育

## 天文知识

### 为什么农历十五满月在傍晚升起？

满月时，太阳、地球、月亮呈一条直线，月亮在地球的另一侧。当太阳在西方落下时，月亮正好从东方升起。这就是为什么满月总是在日落时分升起，日出时分落下。

### 为什么月升时间每天延迟约50分钟？

月亮每天绕地球运行约12度，而地球自转速度是360°/天 = 15°/小时。因此：
```
12° ÷ 15°/小时 ≈ 0.8小时 = 48分钟
```

这就是为什么月亮的升起时间每天比前一天晚约50分钟。

## 技术架构

- **后端**: Flask（Python Web框架）
- **天文计算**: Skyfield（NASA JPL星历表）
- **农历转换**: lunarcalendar
- **前端**: Jinja2模板 + Alpine.js + Tailwind CSS
- **缓存**: Flask-Caching

## 快速开始

### 1. 克隆或下载项目

```bash
cd moonraise
```

### 2. 创建虚拟环境（推荐）

**Windows:**
```bash
python -m venv venv
venv\Scripts\activate
```

**Linux/Mac:**
```bash
python3 -m venv venv
source venv/bin/activate
```

### 3. 安装依赖

```bash
pip install -r requirements.txt
```

### 4. 运行程序

```bash
python run.py
```

**首次运行时**，Skyfield会自动下载JPL DE421星历表文件（约17MB），这是正常现象。下载完成后，后续运行无需重新下载。

### 5. 访问应用

在浏览器中打开：
```
http://localhost:5000
```

## 项目结构

```
moonraise/
├── app/                        # 应用主目录
│   ├── __init__.py            # Flask应用工厂
│   ├── main.py                # 路由和API
│   ├── astronomy/             # 天文计算模块
│   │   └── moon_calculator.py # 月球计算器
│   ├── calendar/              # 日历模块
│   │   └── lunar_converter.py # 农历转换器
│   ├── data/                  # 数据文件
│   │   └── cities.py          # 城市坐标数据
│   ├── static/                # 静态文件
│   │   └── js/
│   │       └── app.js         # Alpine.js逻辑
│   └── templates/             # HTML模板
│       ├── base.html          # 基础模板
│       └── index.html         # 主页
├── config.py                  # 配置文件
├── requirements.txt           # Python依赖
├── run.py                     # 应用入口
└── README.md                  # 本文件
```

## 功能说明

### 1. 城市选择

支持50个中国主要城市，包括：
- **直辖市**: 北京、上海、重庆、天津
- **省会城市**: 所有省会及自治区首府
- **重要城市**: 深圳、苏州、青岛等

每个城市都有精确的经纬度坐标，确保计算结果准确。

### 2. 月相计算

程序使用Skyfield库计算8种主要月相：
- 🌑 新月（朔）
- 🌒 峨眉月
- 🌓 上弦月
- 🌔 盈凸月
- 🌕 满月（望）
- 🌖 亏凸月
- 🌗 下弦月
- 🌘 残月

### 3. 月升月落时间

基于观测者的地理位置和日期，精确计算：
- 月升时间（月亮从地平线升起）
- 月落时间（月亮从地平线落下）
- 特殊情况（全天可见、月不出等）

### 4. 农历显示

自动转换公历到农历，显示：
- 农历年份（干支纪年，如"甲辰年"）
- 农历月份（如"正月"、"闰二月"）
- 农历日期（如"十五"）
- 生肖

### 5. 整月日历

以日历网格形式展示整月数据，每个日期显示：
- 公历日期
- 农历日期
- 月相图标和名称
- 光照比例
- 月升月落时间

## API接口

### 获取单日数据

```
GET /api/moon/<city_id>/<date>
```

**示例**:
```
GET /api/moon/beijing/2024-02-24
```

**返回**:
```json
{
  "city": {...},
  "date": "2024-02-24",
  "phase": {
    "angle": 175.32,
    "illumination": 98.5,
    "name": "满月",
    "emoji": "🌕",
    "type": "full"
  },
  "rise_set": {
    "moonrise": "18:15",
    "moonset": "06:30"
  },
  "lunar": {
    "formatted": "甲辰年正月十五",
    ...
  }
}
```

### 获取整月数据

```
GET /api/calendar/<city_id>/<year>/<month>
```

**示例**:
```
GET /api/calendar/beijing/2024/2
```

## 验证与测试

计算结果已与以下权威数据源验证：
- ✅ [timeanddate.com](https://www.timeanddate.com/moon/) - 月升月落时间
- ✅ NASA月相日历 - 月相精度
- ✅ 香港天文台 - 中文天文数据
- ✅ 中国万年历 - 农历转换

## 性能优化

- **缓存机制**: 整月数据缓存1小时，减少重复计算
- **星历表管理**: 一次下载，永久使用
- **按需加载**: 仅在需要时计算数据

## 依赖说明

| 库名 | 版本 | 用途 |
|------|------|------|
| Flask | 3.0.0 | Web框架 |
| skyfield | 1.48 | 天文计算 |
| lunarcalendar | 0.0.9 | 农历转换 |
| pytz | 2024.1 | 时区处理 |
| Flask-Caching | 2.1.0 | 缓存 |

## 常见问题

### Q: 首次运行很慢？
A: 首次运行时Skyfield会下载约17MB的星历表文件，这是正常现象。下载完成后，后续运行会很快。

### Q: 为什么有些日期显示"月不出"或"全天可见"？
A: 在高纬度地区（如哈尔滨、乌鲁木齐），某些日期可能出现极地现象，导致月亮全天可见或全天不可见。

### Q: 计算结果准确吗？
A: 程序使用NASA JPL DE421星历表，精度达到天文级别。对于民用观测来说，精度完全足够。

### Q: 支持其他国家的城市吗？
A: 当前版本仅支持中国城市。如需添加其他城市，可在`app/data/cities.py`中添加城市坐标。

## 未来扩展

可能的功能扩展方向：
- 📸 月亮摄影最佳时间推荐
- 🌊 沿海城市潮汐信息
- 📅 历史日期查询（查询生日当天的月相）
- 🌍 多城市对比视图
- 📄 PDF导出功能

## 教育价值

这个程序不仅是一个工具，更是一个学习天文知识的平台：

1. **理解月相周期**: 通过整月日历直观看到月相从新月到满月再到新月的完整周期
2. **理解月升规律**: 理解为什么满月在傍晚升起，以及为什么每天延迟50分钟
3. **学习农历系统**: 了解农历与月相的关系（初一=新月，十五=满月）
4. **天文观测指导**: 知道何时何地可以看到特定月相

## 贡献

欢迎提交Issue和Pull Request！

## 许可证

MIT License

## 致谢

- **Skyfield**: 感谢Brandon Rhodes开发的优秀天文库
- **NASA JPL**: 提供高精度星历表数据
- **lunarcalendar**: 中国农历转换库

---

**祝您观月愉快！🌙✨**
