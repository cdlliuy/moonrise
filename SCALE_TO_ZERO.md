# Railway按需启动配置指南

## 💡 什么是按需启动（Scale to Zero）

当没有访问时，Railway会自动暂停您的应用（缩减到0个实例），只在有人访问时才启动。

**优点**:
- ✅ 大幅减少运行时间（可能只有实际使用的几十小时）
- ✅ 完全在免费额度内（500小时/月）
- ✅ 节省费用

**缺点**:
- ❌ 首次访问会有"冷启动"延迟（约10-30秒）
- ❌ 如果长时间不访问，应用会休眠

**是否适合本项目？** ✅ 非常适合！
- 月相程序不需要24小时运行
- 偶尔使用时访问
- 可以接受首次加载稍慢

---

## 🔧 配置方法

Railway有两种方式配置按需启动：

### 方法1: 通过Railway界面配置（推荐）

这是最简单的方式，不需要修改代码。

#### 步骤：

1. **登录Railway** - https://railway.app/

2. **打开您的项目**
   - 找到moonraise项目并点击

3. **进入Settings**
   - 点击您的服务（Service）
   - 点击"Settings"标签

4. **配置Autoscaling**
   - 找到"Autoscaling"部分
   - 启用"Scale to Zero on Idle"

5. **设置空闲时间**
   - **Idle Timeout**: 设置为5-10分钟
   - 意思：如果10分钟内没有请求，自动缩减到0

6. **保存**
   - 设置会自动保存
   - 应用会自动重启

**完成！** 现在您的应用会自动休眠和唤醒。

---

### 方法2: 通过railway.json配置文件（高级）

如果您想通过代码管理配置，可以创建配置文件。

#### 创建railway.json文件

在项目根目录创建`railway.json`：

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "numReplicas": 1,
    "sleepOnIdle": true,
    "idleTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

**配置说明**:
- `sleepOnIdle: true` - 启用空闲休眠
- `idleTimeout: 300` - 5分钟无请求后休眠（单位：秒）
- `numReplicas: 1` - 只运行1个实例

#### 推送配置

```bash
git add railway.json
git commit -m "Enable scale to zero"
git push
```

Railway会自动应用新配置。

---

## 📊 预期效果

### 运行时间计算

**假设使用场景**:
- 每天使用3次
- 每次使用10分钟
- 每次冷启动需要30秒

**计算**:
```
每天运行时间 = 3次 × (0.5分钟冷启动 + 10分钟使用) = 31.5分钟
每月运行时间 = 31.5分钟 × 30天 = 945分钟 ≈ 15.75小时
```

**结论**: ✅ 远低于500小时免费额度！

### 不同使用频率对比

| 使用场景 | 每天次数 | 每次时长 | 月运行时间 | 是否免费 |
|---------|---------|---------|-----------|---------|
| 偶尔使用 | 2次 | 5分钟 | ~5小时 | ✅ 完全免费 |
| 日常使用 | 5次 | 10分钟 | ~26小时 | ✅ 完全免费 |
| 频繁使用 | 10次 | 15分钟 | ~76小时 | ✅ 完全免费 |
| 重度使用 | 20次 | 20分钟 | ~200小时 | ✅ 完全免费 |
| 24小时运行 | - | - | 720小时 | ❌ 超额$5/月 |

---

## ⏱️ 冷启动时间优化

### 预期冷启动时间
- **Railway唤醒服务**: 5-10秒
- **Flask应用启动**: 2-5秒
- **Skyfield初始化**: 1-2秒（已有星历表）
- **总计**: 约10-20秒

### 优化建议

#### 1. 保持应用轻量（已完成）
✅ 已通过`.railwayignore`排除不必要文件

#### 2. 预热重要路由
在`app/main.py`中添加健康检查端点：

```python
@bp.route('/health')
def health():
    """健康检查端点，用于Railway预热"""
    return {'status': 'ok', 'app': 'moonraise'}
```

Railway可以定期ping这个端点，保持应用活跃。

#### 3. 使用Railway的Keepalive（可选）
如果想在特定时段保持活跃（比如白天）：
- 使用第三方服务（如UptimeRobot）
- 每5分钟ping一次健康检查端点
- 应用就不会休眠

---

## 🎯 推荐配置

### 个人使用推荐
```json
{
  "deploy": {
    "sleepOnIdle": true,
    "idleTimeout": 600
  }
}
```
- 10分钟空闲后休眠
- 平衡了响应速度和资源节省

### 分享给朋友推荐
```json
{
  "deploy": {
    "sleepOnIdle": true,
    "idleTimeout": 300
  }
}
```
- 5分钟空闲后休眠
- 更快释放资源

### 演示/展示推荐
```json
{
  "deploy": {
    "sleepOnIdle": false
  }
}
```
- 不休眠，保持响应快速
- 适合短期演示（几天）

---

## 📱 用户体验说明

### 首次访问（冷启动）
```
用户打开网站
↓
显示"正在启动..."（10-20秒）
↓
应用启动完成
↓
正常使用
```

### 后续访问（热状态）
```
用户打开网站
↓
立即响应（< 1秒）
↓
正常使用
```

### 建议
在网站上添加加载提示，让用户知道应用正在启动：

```html
<!-- 在index.html中添加 -->
<div id="loading" style="display:none;">
  <p>🌙 正在启动月相计算服务...</p>
  <p>首次访问可能需要10-20秒，请稍候</p>
</div>
```

---

## 🔍 监控和调试

### 查看运行时间统计

1. **Railway Dashboard**
   - 登录Railway
   - 点击项目
   - 查看"Usage"标签
   - 可以看到实时运行时间

2. **Railway CLI**（可选）
   ```bash
   # 安装Railway CLI
   npm i -g @railway/cli

   # 查看使用情况
   railway status
   ```

### 检查休眠状态

访问Railway项目页面：
- **绿色"Active"**: 应用正在运行
- **灰色"Sleeping"**: 应用已休眠
- **黄色"Waking"**: 应用正在唤醒

---

## ⚠️ 注意事项

### 1. 数据持久化
Scale to Zero模式下：
- ✅ 代码不会丢失
- ✅ 星历表文件不会丢失（存储在磁盘）
- ✅ 缓存会清空（重启后重新计算）

### 2. 第一次访问
部署后的第一次访问：
- 可能需要下载星历表（如果还没有）
- 时间会更长（可能1-2分钟）
- **建议**: 部署后先自己访问一次，确保星历表下载完成

### 3. 免费额度监控
- Railway会发邮件提醒快超额
- 建议每月检查一次使用情况
- 如果接近500小时，调整使用频率

---

## 🚀 立即配置

### 快速开始（推荐）

**选项A: 使用Railway界面**（最简单）
1. 访问 https://railway.app/
2. 打开您的项目
3. Settings → Autoscaling → 启用"Scale to Zero on Idle"
4. 设置Idle Timeout为10分钟
5. 完成！

**选项B: 使用配置文件**
我可以帮您创建`railway.json`文件并推送到GitHub。

---

## 💡 最佳实践

### 推荐设置组合

**日常个人使用**:
```
Idle Timeout: 10分钟
预期月费用: $0（完全免费）
```

**偶尔查看**:
```
Idle Timeout: 5分钟
预期月费用: $0（完全免费）
```

**需要快速响应**:
```
Idle Timeout: 30分钟
使用Keepalive保持白天活跃
预期月费用: $0-2（基本免费）
```

---

## 📝 总结

通过启用Scale to Zero：
- ✅ 运行时间从720小时降至15-200小时
- ✅ 完全在免费额度内
- ✅ 无需支付任何费用
- ⚠️ 首次访问有10-20秒延迟
- ✅ 非常适合个人使用的月相程序

**我的建议**:
立即启用Scale to Zero，设置10分钟空闲超时。这样既节省资源，又保持良好的用户体验。

---

**需要我帮您创建railway.json配置文件吗？**
或者您更倾向于使用Railway界面配置？
